# Harmonic Flow's GRUB Configuration --- Use ThinkPads with Coreboot Firmware.
# Modules 'cbfs' and 'normal' are supposed to be already loaded,
# as well as its dependencies: terminal crypto extcmd boot gettext

# Prefix --- The location of the "/boot/grub" directory as an absolute file name.
set prefix=(memdisk)/boot/grub

# Load Modules --- Load selected modules which are not loaded due
# to dependencies and which have probably not been pre-loaded.
insmod nativedisk
insmod luks
insmod lvm
insmod ahci
insmod ohci
insmod uhci
insmod ehci
insmod part_msdos
insmod part_gpt
insmod fat
insmod ext2
insmod usbms
insmod usb_keyboard
insmod usbserial_usbdebug
insmod syslinuxcfg
insmod cryptodisk
insmod jpeg

# Desktop Boards --- Let's load additional modules:
insmod at_keyboard
insmod pata

# Set Environment
set gfxpayload=keep
set pager=1
set default=0
set timeout_style="menu"
set timeout=5
set color_highlight=white/green
set color_normal=light-gray/black

# Terminal Settings
terminal_input --append at_keyboard
terminal_output --append cbmemc
terminal_output --append gfxterm

# VESA Framebuffer Settings
background_image (cbfsdisk)/background.jpg
loadfont dejavusansmono

# Keymap --- several options available, adapt to your needs:
# us gb de be nl it es pt fr tr ro bg pl cz hu se dk fi 
# us_intl us_dvorak ca_fr tr_f ch_de ch_fr sk_qwerty fr_latin9 de_nodeadkeys 
keymap se

# GRUB Functions and Menu Options --- borrowed from the Libreboot Project
function try_user_config {
	set root="${1}"
	for dir in boot grub grub2 boot/grub boot/grub2; do
		for name in '' autoboot_ libreboot_ coreboot_; do
			if [ -f /"${dir}"/"${name}"grub.cfg ]; then
				unset superusers
				configfile /"${dir}"/"${name}"grub.cfg
			fi
		done
	done
}
function search_grub {
	for i in 0 1; do
		# raw devices
		try_user_config "(${1}${i})"
		for part in 1 2 3 4 5; do
			# MBR/GPT partitions
			try_user_config "(${1}${i},${part})"
		done
	done
}
function try_isolinux_config {
	set root="${1}"
	for dir in '' /boot; do
		if [ -f "${dir}"/isolinux/isolinux.cfg ]; then
			syslinux_configfile -i "${dir}"/isolinux/isolinux.cfg
		elif [ -f "${dir}"/syslinux/syslinux.cfg ]; then
			syslinux_configfile -s "${dir}"/syslinux/syslinux.cfg
		fi
	done
}
function search_isolinux {
	for i in 0 1; do
		# raw devices
		try_isolinux_config "(${1}${i})"
		for part in 1 2 3 4 5; do
			# MBR/GPT partitions
			try_isolinux_config "(${1}${i},${part})"
		done
	done
}
menuentry '[g]  Search GRUB2 Configuration (AHCI)' --hotkey='g' {
	search_grub ahci
}
menuentry '[o] Load OS Encrypted /boot.. (default settings)' --hotkey='o' {
    cryptomount -a
    set root='lvm/matrix-rootvol'
    linux /vmlinuz root=/dev/mapper/matrix-rootvol cryptdevice=/dev/mapper/matrix-rootvol:root
    initrd /initrd.img
}
menuentry '[i] Load OS Encrypted /boot.. (with iomem=relaxed) ' --hotkey='i' {
    cryptomount -a
    set root='lvm/matrix-rootvol'
    linux /vmlinuz root=/dev/mapper/matrix-rootvol cryptdevice=/dev/mapper/matrix-rootvol:root iomem=relaxed
    initrd /initrd.img
}
menuentry '[s]  Search GRUB2 Configuration (USB)' --hotkey='s' {
	search_grub usb
}
menuentry '[u]  Search ISOLINUX Menu (USB)' --hotkey='u' {
	search_isolinux usb
}
menuentry '[a]  Search ISOLINUX Menu (AHCI)' --hotkey='a' {
	search_isolinux ahci
}
menuentry '[d]  Search ISOLINUX Menu (CD/DVD)' --hotkey='d' {
	try_isolinux_config ahci1
}
menuentry '[p]  Poweroff' --hotkey='p' {
	halt --no-apm
}
menuentry '[r]  Reboot' --hotkey='r' {
	reboot
}
